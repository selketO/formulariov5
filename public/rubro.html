<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Solicitud de Cambio de Rubro</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="./css/rubros.css">
</head>
<body>
    <div class="header">
        <img src="/img/LOGO BCL H.png" alt="Logo">
        <h1>Solicitud de Cambio de Rubro</h1>    
        <button class="button" onclick="location.href='Reporte.html'">Ir a los Rubros</button>
    </div>
    <form id="formRubros">
        <div class="form-group">
            <label for="rubroOrigen">Rubro Origen:</label>
            <select id="rubroOrigen" class="select2" data-live-search="true">
                <option value="">Seleccionar Rubro</option>
            </select>
        </div>

        <div class="form-group">
            <label for="rubroDestino">Rubro Destino:</label>
            <select id="rubroDestino" class="select2" data-live-search="true">
                <option value="">Seleccionar Rubro</option>
            </select>
        </div>

        <div class="saldo-info">
            <p>Saldo actual Rubro Origen: <span id="saldoOrigen">0</span></p>
            <p>Saldo actual Rubro Destino: <span id="saldoDestino">0</span></p>
        </div>

        <div class="form-group">
            <label for="cantidadTransferir">Cantidad a Transferir:</label>
            <input type="number" id="cantidadTransferir" value="0" min="0" step="0.01">
        </div>

        <div class="saldo-info">
            <p>Saldo Final Rubro Origen: <span id="saldoFinalOrigen">0</span></p>
            <p>Saldo Final Rubro Destino: <span id="saldoFinalDestino">0</span></p>
        </div>

        <div class="form-group">
            <label for="applicant">Solicitante:</label>
            <select id="applicant">
                <option value="">Seleccionar Solicitante</option>
                <option value="francisco@biancorelab.com">Francisco Macias</option>
                <option value="edelgado@biancorelab.com">Edhson Delgado</option>
                <option value="cloera@biancorelab.com">Christian Loera</option>
                <option value="carlos@biancorelab.com">Carlos Ancona</option>
                <option value="luis@biancorelab.com">Luis Ceballos</option>
            </select>
        </div>
        
        <button type="submit">Enviar Solicitud</button>
    </form>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <script>
        $(document).ready(function() {

            $('.select2').select2();
            const actualizaSaldos = () => {
                const origenId = $('#rubroOrigen').val();
                const destinoId = $('#rubroDestino').val();

                if (origenId && destinoId) {
                    $.get(`/api/saldos?origen=${origenId}&destino=${destinoId}`, function(data) {
                        if (data.origen && data.destino) {
                            $('#saldoOrigen').text(numberWithCommas(data.origen.Acumulado));
                            $('#saldoDestino').text(numberWithCommas(data.destino.Acumulado));

                            const cantidad = parseFloat($('#cantidadTransferir').val()) || 0;
                            const saldoFinalOrigen = data.origen.Acumulado - cantidad;
                            const saldoFinalDestino = data.destino.Acumulado + cantidad;

                            $('#saldoFinalOrigen').text(numberWithCommas(saldoFinalOrigen));
                            $('#saldoFinalDestino').text(numberWithCommas(saldoFinalDestino));
                        }
                    }).fail(function(error) {
                        console.error('Error al obtener los saldos', error);
                    });
                }
            };

            function numberWithCommas(x) {
                return x.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            }

            $.get('/api/rubros', function(rubros) {
                rubros.forEach(function(rubro) {
                    $('#rubroOrigen, #rubroDestino').append(new Option(rubro.Concepto, rubro._id));
                });
                actualizaSaldos();
            });

            $('#rubroOrigen').change(function() {
                const origenId = $(this).val();
                $('#rubroDestino option').prop('disabled', false);
                $('#rubroDestino option[value="' + origenId + '"]').prop('disabled', true);
                $('#rubroDestino').trigger('change.select2');
                actualizaSaldos();
            });

            $('#rubroDestino').change(function() {
                const destinoId = $(this).val();
                $('#rubroOrigen option').prop('disabled', false);
                $('#rubroOrigen option[value="' + destinoId + '"]').prop('disabled', true);
                $('#rubroOrigen').trigger('change.select2');
                actualizaSaldos();
            });

            $('#cantidadTransferir').on('input', actualizaSaldos);

            $('#formRubros').submit(function(e) {
                e.preventDefault();
                const origen = $('#rubroOrigen').val();
                const destino = $('#rubroDestino').val();
                const cantidad = parseFloat($('#cantidadTransferir').val());
                const applicant = document.getElementById('applicant').value;
                if (isNaN(cantidad) || cantidad <= 0) {
                    alert('Por favor ingresa una cantidad vÃ¡lida.');
                    return;
                }

                $.ajax({
                    url: '/api/transferencia',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ origen, destino, cantidad, applicant }),
                    success: function(response) {
                        alert('Transferencia realizada: ' + response.message);
                        actualizaSaldos();
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        alert('Error en la transferencia: el rubro de origen no puede quedar en negativo' + textStatus);
                    }
                });
            });
        });
    </script>
</body>
</html>
