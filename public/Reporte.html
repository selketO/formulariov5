<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./css/reporte.css">
  <title>Reporte de Datos</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css">
</head>
<body>
  <div class="container py-5">
    <h1 class="text-center">Reporte de Rubros</h1>

    <div class="mb-4">
      <input type="text" class="form-control" id="searchInput" placeholder="Buscar concepto..." oninput="filterTable()">
      <select class="form-control" id="areaFilter" onchange="filterTable()">
        <option value="">Todas las áreas</option>
      </select>
    </div>

    <table class="table table-striped table-bordered">
      <thead>
        <tr>
          <th>Concepto</th>
          <th>Área</th>
          <th>Presupuesto</th>
          <th>Real</th>
          <th>Diferencia ($)</th>
          <th>Diferencia (%)</th>
        </tr>
      </thead>
      <tbody>
        <!-- Los datos se insertarán aquí -->
      </tbody>
      <tfoot>
        <tr>
          <td colspan="2">Total</td>
          <td id="totalPresupuesto">0</td>
          <td id="totalReal">0</td>
          <td id="totalDiferencia">$0</td>
          <td id="totalDiferenciaPercent">0.00%</td>
        </tr>
      </tfoot>
    </table>
  </div>

  <script>
    let totalPresupuestoAll = 0;
    let totalRealAll = 0;
    let totalDiferenciaAll = 0;

    // Función para llenar la tabla con los datos
    function fillTable(data) {
      const tableBody = document.querySelector('tbody');
      tableBody.innerHTML = '';

      totalPresupuestoAll = 0;
      totalRealAll = 0;
      totalDiferenciaAll = 0;

      // Llenar la lista desplegable de áreas
      const areaFilter = document.querySelector('#areaFilter');
      areaFilter.innerHTML = '<option value="">Todas las áreas</option>';
      const areas = new Set(data.map(item => item.Area));
      areas.forEach(area => {
        const option = document.createElement('option');
        option.value = area;
        option.text = area;
        areaFilter.add(option);
      });

      let totalPresupuestoVisible = 0;
      let totalRealVisible = 0;
      let totalDiferenciaVisible = 0;

      data.forEach(item => {
        const row = document.createElement('tr');

        const conceptoCell = document.createElement('td');
        conceptoCell.textContent = item.Concepto;
        row.appendChild(conceptoCell);

        const areaCell = document.createElement('td');
        areaCell.textContent = item.Area;
        row.appendChild(areaCell);

        const presupuestoCell = document.createElement('td');
        presupuestoCell.textContent = formatNumber(item.Presupuesto);
        row.appendChild(presupuestoCell);
        totalPresupuestoAll += item.Presupuesto;
        totalPresupuestoVisible += item.Presupuesto;

        const realCell = document.createElement('td');
        realCell.textContent = formatNumber(item.Real);
        row.appendChild(realCell);
        totalRealAll += item.Real;
        totalRealVisible += item.Real;

        const diferencia = item.Real - item.Presupuesto;
        const diferenciaCell = document.createElement('td');
        diferenciaCell.textContent = formatNumber(diferencia);
        if (diferencia < 0) {
          diferenciaCell.classList.add('negative');
        } else if (diferencia > 0 && diferencia >= 0.01) {
          diferenciaCell.classList.add('positive');
        }
        row.appendChild(diferenciaCell);
        totalDiferenciaAll += diferencia;
        totalDiferenciaVisible += diferencia;

        const diferenciaPercent = document.createElement('td');
        let percent;
        if (isNaN(diferencia) || item.Presupuesto === 0) {
          percent = '0.00%';
        } else {
          percent = `${((diferencia / item.Presupuesto) * 100).toFixed(2)}%`;
        }
        diferenciaPercent.textContent = percent;
        if (isNaN(diferencia)) {
          diferenciaPercent.classList.add('zero-percent');
        } else if (diferencia < 0) {
          diferenciaPercent.classList.add('negative');
        } else if (diferencia > 0 && diferencia >= 0.01) {
          diferenciaPercent.classList.add('positive');
        }
        row.appendChild(diferenciaPercent);

        tableBody.appendChild(row);
      });

      updateTotal();
    }

    // Función para actualizar el total
    function updateTotal() {
      document.querySelector('#totalPresupuesto').textContent = formatNumber(totalPresupuestoAll.toFixed(2));
      document.querySelector('#totalReal').textContent = formatNumber(totalRealAll.toFixed(2));
      document.querySelector('#totalDiferencia').textContent = formatNumber(totalDiferenciaAll.toFixed(2));
      document.querySelector('#totalDiferenciaPercent').textContent = `${((totalDiferenciaAll / totalPresupuestoAll) * 100).toFixed(2)}%`;
    }

    // Función para filtrar la tabla
    function filterTable() {
      const searchInput = document.querySelector('#searchInput').value.toLowerCase();
      const areaFilter = document.querySelector('#areaFilter').value;

      const tableRows = document.querySelectorAll('tbody tr');
      let totalPresupuestoVisible = 0;
      let totalRealVisible = 0;
      let totalDiferenciaVisible = 0;

      tableRows.forEach(row => {
        const concepto = row.cells[0].textContent.toLowerCase();
        const area = row.cells[1].textContent;

        const showRow = concepto.includes(searchInput) && (areaFilter === '' || area === areaFilter);
        row.style.display = showRow ? '' : 'none';
        if (showRow) {
          totalPresupuestoVisible += parseFloat(row.cells[2].textContent.replace(/,/g, ''));
          totalRealVisible += parseFloat(row.cells[3].textContent.replace(/,/g, ''));
          totalDiferenciaVisible += parseFloat(row.cells[4].textContent.replace(/,/g, ''));
        }
      });

      document.querySelector('#totalPresupuesto').textContent = formatNumber(totalPresupuestoVisible.toFixed(2));
      document.querySelector('#totalReal').textContent = formatNumber(totalRealVisible.toFixed(2));
      document.querySelector('#totalDiferencia').textContent = formatNumber(totalDiferenciaVisible.toFixed(2));
      document.querySelector('#totalDiferenciaPercent').textContent = `${((totalDiferenciaVisible / totalPresupuestoVisible) * 100).toFixed(2)}%`;

      if (searchInput === '' && areaFilter === '') {
        updateTotal();
      }
    }

    // Función para formatear números con comas y puntos
    function formatNumber(number) {
      return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    // Llamar a la función fillTable con los datos obtenidos del servidor
    fetch('/api/report-data')
      .then(response => response.json())
      .then(data => fillTable(data))
      .catch(error => console.error('Error al obtener los datos:', error));
  </script>
</body>
</html>
